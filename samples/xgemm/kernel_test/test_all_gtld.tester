#!/usr/bin/env bash

if [[ ${LIBXSMM_TARGET} == "knm" ]]; then
  exit 0;
fi
if [[ ${LIBXSMM_TARGET} == "snb" ]]; then
  exit 0;
fi
if [[ ${LIBXSMM_TARGET} == "wsm" ]]; then
  exit 0;
fi

TESTFILE1=$(mktemp -p .)
TESTFILE2=$(mktemp -p .)
TESTFILE3=$(mktemp -p .)
TESTFILE4=$(mktemp -p .)
TESTFILE5=$(mktemp -p .)
TESTFILE6=$(mktemp -p .)
TESTFILE7=$(mktemp -p .)
TESTFILE8=$(mktemp -p .)

if [ -x "$(command -v python3)" ]; then
  PYTHON=$(command -v python3)
else
  PYTHON=$(command -v python)
fi

${PYTHON} << END
import random as rnd
import time as time
rnd.seed(time.time())
randnum = range(1,101,1)
f1 = open("${TESTFILE1}", "w+")
f2 = open("${TESTFILE2}", "w+")
f3 = open("${TESTFILE3}", "w+")
f4 = open("${TESTFILE4}", "w+")
f5 = open("${TESTFILE5}", "w+")
f6 = open("${TESTFILE6}", "w+")
f7 = open("${TESTFILE7}", "w+")
f8 = open("${TESTFILE8}", "w+")
i = 0
for m in randnum:
    for n in randnum:
        for k in randnum:
            line = str(m) + ' ' + str(n) + ' ' + str(k) + ' 100 100 100\n'
            if 0 == (i % 8):
                f1.write(line)
            elif 1 == (i % 8):
                f2.write(line)
            elif 2 == (i % 8):
                f3.write(line)
            elif 3 == (i % 8):
                f4.write(line)
            elif 4 == (i % 8):
                f5.write(line)
            elif 5 == (i % 8):
                f6.write(line)
            elif 6 == (i % 8):
                f7.write(line)
            else:
                f8.write(line)
            i = i + 1
f1.close()
f2.close()
f3.close()
f4.close()
f5.close()
f6.close()
f7.close()
f8.close()
END

PREC="SP"
TRA=0
TRB=0
BINARY_POSTOP=1
UNARY_POSTOP=3
CVNNI=0
BRTYPE="nobr"
BRCOUNT=5
TESTFUSED=1

./kernel_fused ${TESTFILE1} 1 1 0 0 ${TRA} ${TRB} ${PREC} ${BRTYPE} ${BRCOUNT} 1 1 1 0 ${BINARY_POSTOP} ${UNARY_POSTOP} ${CVNNI}
./kernel_fused ${TESTFILE2} 1 1 0 0 ${TRA} ${TRB} ${PREC} ${BRTYPE} ${BRCOUNT} 1 1 1 0 ${BINARY_POSTOP} ${UNARY_POSTOP} ${CVNNI}
./kernel_fused ${TESTFILE3} 1 1 0 0 ${TRA} ${TRB} ${PREC} ${BRTYPE} ${BRCOUNT} 1 1 1 0 ${BINARY_POSTOP} ${UNARY_POSTOP} ${CVNNI}
./kernel_fused ${TESTFILE4} 1 1 0 0 ${TRA} ${TRB} ${PREC} ${BRTYPE} ${BRCOUNT} 1 1 1 0 ${BINARY_POSTOP} ${UNARY_POSTOP} ${CVNNI}
./kernel_fused ${TESTFILE5} 1 1 0 0 ${TRA} ${TRB} ${PREC} ${BRTYPE} ${BRCOUNT} 1 1 1 0 ${BINARY_POSTOP} ${UNARY_POSTOP} ${CVNNI}
./kernel_fused ${TESTFILE6} 1 1 0 0 ${TRA} ${TRB} ${PREC} ${BRTYPE} ${BRCOUNT} 1 1 1 0 ${BINARY_POSTOP} ${UNARY_POSTOP} ${CVNNI}
./kernel_fused ${TESTFILE7} 1 1 0 0 ${TRA} ${TRB} ${PREC} ${BRTYPE} ${BRCOUNT} 1 1 1 0 ${BINARY_POSTOP} ${UNARY_POSTOP} ${CVNNI}
./kernel_fused ${TESTFILE8} 1 1 0 0 ${TRA} ${TRB} ${PREC} ${BRTYPE} ${BRCOUNT} 1 1 1 0 ${BINARY_POSTOP} ${UNARY_POSTOP} ${CVNNI}

rm ${TESTFILE1}
rm ${TESTFILE2}
rm ${TESTFILE3}
rm ${TESTFILE4}
rm ${TESTFILE5}
rm ${TESTFILE6}
rm ${TESTFILE7}
rm ${TESTFILE8}
